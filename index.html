<html>
<head>
	<title>Perfect Match 2020 Results</title>
	<meta charset="UTF-8">
	<script src="https://d3js.org/d3.v5.min.js"></script>
	<link href="https://fonts.googleapis.com/css?family=Inconsolata&display=swap" rel="stylesheet">
	<link href="https://fonts.googleapis.com/css?family=Montserrat:200,200i&display=swap" rel="stylesheet">
</head>
<body bgcolor = "#FB6466" style="text-align: center; margin-top: 50; color: #505050;">
	<div style="margin: 0 auto; width: 800;font-family: Montserrat; font-size: 20; font-weight: bold; color: #505050; text-align: left;">
		<h4>In 2020, 5618 students signed up to meet their perfect match. We hope to provide insights on the general trends of Cornell students as well as conversation starters for your next date! </h4>
		<h4>Over a third of Cornell's student body participated in our survey. Let's take a look at the breakdown of different demographics:</h4>
		<svg height="500" width="800" class="generalBar"></svg>

		<h4 style="margin-top: 50px;">For better or worse, height is one of the first qualities that people evaluate when looking for a significant other. Interested to see how your height compares to other students' on campus?</h4>
		<svg height="400" width="800" class="heightChart"></svg>

		<h4>Need to know the best time to plan a date or make an impromptu phone call? Here is the aggregate data on when people are most likely to fall asleep and wake up. </h4>
		<svg height="500" width="800" class="timeDials"></svg>

		<h4 style="margin-top: 50px;">Based on a series of questions, we categorized students into 1 of 16 personalities on the Myers Briggs Type Indicator. While the science behind personality compatibilities is lacking, it is still fun to compare MBTI results with your perfect match as well as to see how you compare to students within your college. </h4>
		<svg height="600" width="800" class="heatmap"></svg>

		<h4 style="margin-bottom: 50px;">In need of topics to fill that awkward silence? Here are the aggregate answers to controversial questions that we posed to our respondents. Do your answers agree with results?</h4>
		<svg height="800" width="800" class="polls"></svg>

		<h4 style="margin-top: 50px;">Before you go on that first date, you should be aware of your matches' commitment levels. Here's what people were looking to get out of Perfect Match: </h4>
		<svg height="450" width="800" class="commitmentBar"></svg>
	</div>
	<script>
		var data;
		var finalCSV;
		var padding = 25;

		var firstSvgWidth = 800;
		var firstSvgHeight = 500;
		var secSvgWidth = 800;
		var secSvgHeight = 400;
		var thirdSvgWidth = 800;
		var thirdSvgHeight = 500;
		var commitmentSvgHeight = 450;
		
		var minHeight = 51; 

		var darkTextColor = "#505050";
		var maroonColor = "#A7333F";

		var blueColor = "#88C8EA";
		var pinkColor = "#FFADC6";
		var whiteColor = "#fbfbfb";
		var lightGreyColor = "#cdcdcd";
		/** Functions for parsing initial raw data **/
		// get results based on key (ie. data.gender) and sorts key in descending value
		function getSummary(data, str, newKey = "", isList = false) {
			let map = {};

			for (let i = 0; i < data.length; i++) {
				if (isList) {
					let keys = (data[i][str].replace(/\"/g, '').replace("[", '').replace("]", '')).split(",");
					for (let j = 0; j < keys.length; j++) {
						let key = keys[j].trim().toLowerCase();
						if (key != "") { // remove unfinished surveys
							if (!map[newKey+key]) {
								map[newKey+key] = 1;
							} else {
								map[newKey+key] = map[newKey+key] + 1;
							}
						}
					}
				} else {
					let key = data[i][str].trim().toLowerCase();
					if (key != "") { // remove unfinished surveys
						if (!map[newKey+key]) {
							map[newKey+key] = 1;
						} else {
							map[newKey+key] = map[newKey+key] + 1;
						}
					}
				}
				
			}

			return map;
		}

		function getHeightList(data, isFemale) {
			let key;
			let map = {};
			if (isFemale) {
				key = "female";
			} else {
				key = "male";
			}

			// initialize map
			for (let i = 50; i < 85; i++) {
				map[i] = 0;
			}

			for (let i = 0; i < data.length; i++) {
				if (data[i]["data.gender"] == key) {
					let height = data[i]["data.height"];

					// convert feet to inches
					if (height < 50) {
						height = height * 12;
					}

					height = (+height).toFixed(0);

					if (height < 85 && height > 50) {
						map[height] = map[height] + 1;
					}
					
				}
			}

			let finalList = [];
			// convert map to list
			for (let i = 50; i < 85; i++) {
				finalList[i-50] = map[i];
			}

			return finalList;
		}

		function getSleepHabits(data, isSleep) {
			let key;
			let map = {};
			if (isSleep) {
				key = "sleeptime";
			} else {
				key = "waketime";
			}

			for (let i = 0; i < data.length; i++) {
				if (data[i]["data.gender"] != "") { // ignore uncomplete survey answers
					let time = JSON.parse(data[i]["data.sleephabits"]);
					time = time[key].toLowerCase()
						.replace("am", "")
						.replace("a.m.", "")
						.replace("a.m", "")
						.replace("pm", "")
						.replace("p", "")
						.replace(":00", "")
						.replace(":15", "")
						.replace(".30", "")
						.replace(":30", "")
						.trim();

					if (time.includes("-")) {
						time = time.split("-")[0].trim();
					}

					if (time.includes("or")) {
						time = time.split("or")[0].trim();
					}

					if (time == "midnight") {
						time = "12";
					} else if (time == "01") {
						time = "1";
					} else if (time == "02") {
						time = "2";
					} else if (time == "03") {
						time = "3";
					} else if (time == "09") {
						time = "9";
					} else if (time == "08") {
						time = "8"
					} else if (time == "06") {
						time = "6";
					}

					if (Number.isInteger(+time) && +time < 13 && +time > 0) {
						if (!map[time]) {
							map[time] = 1;
						} else {
							map[time] = map[time] + 1;
						}
					}
				}
			}
			return map;
		}

		function getPersonalities(data, key) {
			var blankMap = {"INTJ": 0, "INTP": 0, "ENTJ": 0, "ENTP": 0, "INFJ": 0, "INFP": 0, "ENFJ": 0, "ENFP": 0, "ISTJ": 0, "ISFJ": 0, "ESTJ": 0, "ESFJ": 0, "ISTP": 0, "ISFP": 0, "ESTP": 0, "ESFP": 0};
			var map = {};

			for (let i = 0; i < data.length; i++) {
				var tempCollege = data[i][key];
				if (!map[tempCollege]) {
					map[tempCollege] = {...blankMap};
					var tempP = data[i]["personality"];
					map[tempCollege][tempP] = 1; 
				} else {
					var tempP = data[i]["personality"];
					map[tempCollege][tempP] = map[tempCollege][tempP] + 1; 
				}
			}

			return map;
		}

		function printSortMap(map) {
			var sortedMap = Object.keys(map).map(function(key) {
				return [key, map[key]];
			});

			sortedMap.sort(function(k1, k2) {
				return k2[1] - k1[1];
			});
			for (let i = 0; i < sortedMap.length; i++) {
				console.log(sortedMap[i][0] + ": " + sortedMap[i][1]);
			}
		}

		/** Functions for building data structures **/
		const requestInitialData = async () => {
			let initialData = await d3.csv("answer.csv");
			// console.log(initialData);

			let genderMap = getSummary(initialData, "data.gender", "total_");
			let ethnicityMap = getSummary(initialData, "data.ethnicity", "total_");
			let yearMap = getSummary(initialData, "data.year", "total_");
			let activitiesMap = getSummary(initialData, "data.activities", "total_", true);
			let collegeMap = getSummary(initialData, "data.college", "total_");

			let femaleHeightMap = {"min_height": 50, "female_height": getHeightList(initialData, true)};
			let maleHeightMap = {"male_height": getHeightList(initialData, false)};

			let finalObj = {...genderMap, ...yearMap, ...ethnicityMap, ...activitiesMap, ...collegeMap, ...femaleHeightMap, ...maleHeightMap};
			// console.log(finalObj);

			finalCSV = d3.csvFormat([finalObj]);

			let sleepTimeMap = getSleepHabits(initialData, true);
			let wakeTimeMap = getSleepHabits(initialData, false);
			requestFinalData();

			let todoMap = getSummary(initialData, "data.todolist");
			let startOverMap = getSummary(initialData, "data.startover");
			let timeMoneyMap = getSummary(initialData, "data.timeormoney");
			let qualityMap = getSummary(initialData, "data.quality");
			let planMap = getSummary(initialData, "data.plans");
			let workMap = getSummary(initialData, "data.work");
			let mealMap = getSummary(initialData, "data.meal");

			let personalityMap = getPersonalities(initialData, "data.college");

			let pMapByGender = getPersonalities(initialData, "data.gender");

			let pMap = getSummary(initialData, "personality");

			let fridayMap = getSummary(initialData, "data.friday");
			let dateMap = getSummary(initialData, "data.date");
			let perfectMap = getSummary(initialData, "data.perfectday");

			let commitment = getSummary(initialData, "data.commitment");
			
			let advMe = getSummary(initialData, "data.describepartner", "", true);

			printSortMap(fridayMap);
			console.log("");
			printSortMap(dateMap);
			console.log("");
			printSortMap(perfectMap);
			console.log("");
			printSortMap(commitment);
		};

		const requestFinalData = async () => {
			final();
		}

		function getTotalPeople() {
			return 1359 + 1504 + 1267 + 1232 + 183 + 59 + 14;
		}

		function convertInToFeet(inches) {
			return Math.trunc(inches/12) + " ft "+ inches%12 + " in";
		}

		function calculateMedianForHeight(arr) {
			var totalPersons = 0;

			for (var i in arr) {
				totalPersons += arr[i];
			}
			// console.log(totalPersons);

			var midway = Math.trunc(totalPersons/2);
			var tempIndex = 0;
			for (var i in arr) {
				if (midway < 0) break;
				tempIndex = i;
				midway -= arr[i];
			}
			return Number(tempIndex) + minHeight;
		}


		/** Functions for generating specific data **/
		function createGenderData() {
			return [
				{"key": "male", "value": 2182},
				{"key": "female", "value": 3413},
				{"key": "other", "value": 32}
			];
		}
		function createYearData() {
			return [
				{"key": "freshman", "value": 1359}, 
				{"key": "sophomore", "value": 1504},
				{"key": "junior", "value": 1267},
				{"key": "senior", "value": 1232},
				{"key": "masters", "value": 183},
				{"key": "phd", "value": 59},
				{"key": "faculty", "value": 14}
			];
		}

		function createEthnicityData() {
			return [
				{"key": "white", "value": 2476}, 
				{"key": "east asian", "value": 1324},
				{"key": "south asian", "value": 579},
				{"key": "latino", "value": 394},
				{"key": "black", "value": 361},
				{"key": "other", "value": 484}
			];
		}

		function createActivitiesData() {
			return [
				{"key": "prof. club", "value": 1427}, 
				{"key": "social club", "value": 1659},
				{"key": "cultural club", "value": 1182},
				{"key": "greek life", "value": 1633},
				{"key": "prof. fraternity", "value": 648},
				{"key": "athlete", "value": 506},
				{"key": "club sports", "value": 915},
				{"key": "project team", "value": 900},
				{"key": "ta", "value": 1073},
				{"key": "ra", "value": 176},
				{"key": "other clubs", "value": 2261},
				{"key": "none", "value": 321},
			];
		}

		function createCollegeData() {
			return [
				{"key": "aap", "value": 124}, 
				{"key": "arts", "value": 1649},
				{"key": "cals", "value": 1369},
				{"key": "engineering", "value": 1331},
				{"key": "hotel", "value": 311},
				{"key": "humec", "value": 480},
				{"key": "ilr", "value": 354}	
			];
		}

		function createFemaleHeightData() {
			return [1, 3, 5, 2, 1, 4, 3, 14, 17, 117, 151, 292, 416, 504, 452, 430, 398, 263, 136, 96, 44, 23, 7, 8, 3, 1, 0, 1, 0, 1, 1, 0];
		}

		function createMaleHeightData() {
			return [0, 0, 1, 0, 0, 0, 0, 2, 5, 8, 6, 1, 8, 17, 35, 86, 160, 216, 306, 327, 280, 288, 163, 114, 78, 44, 11, 8, 1, 2, 0, 2];
		}

		function createSleepData() {
			return [
				{"0": 1860},
				{"1": 1719},
				{"2": 801},
				{"3": 157},
				{"4": 25},
				{"5": 11},
				{"6": 8},
				{"7": 0},
				{"8": 0},
				{"9": 0},
				{"10": 0},
				{"11": 0},
				{"12": 0},
				{"13": 0},
				{"14": 0},
				{"15": 0},
				{"16": 0},
				{"17": 0},
				{"18": 7},
				{"19": 22},
				{"20": 20},
				{"21": 18},
				{"22": 129},
				{"23": 686}
			];
		}

		function createWakeData() {
			return [
				{"0": 0},
				{"1": 0},
				{"2": 0},
				{"3": 0},
				{"4": 8},
				{"5": 25},
				{"6": 149},
				{"7": 768},
				{"8": 1816},
				{"9": 1730},
				{"10": 706},
				{"11": 148},
				{"12": 29},
				{"13": 8},
				{"14": 1},
				{"15": 2},
				{"16": 0},
				{"17": 0},
				{"18": 0},
				{"19": 0},
				{"20": 0},
				{"21": 0},
				{"22": 0},
				{"23": 0}
			];
		}

		function createMealData() {
			return [
				{"key": "artist", "value": 2323},
				{"key": "entrepreneur", "value": 820},
				{"key": "actor", "value": 804},
				{"key": "athlete", "value": 655},
				{"key": "politician", "value": 510},
				{"key": "scientist", "value": 506},
			];
		}

		function createBestQualityData() {
			return [
				{"key": "thoughtfulness", "value": 2661},
				{"key": "reliability", "value": 1401},
				{"key": "humor", "value": 1193},
				{"key": "independence", "value": 363}
			];
		}

		function createTimeMoneyData() {
			return [
				{"key": "time", "value": 3844},
				{"key": "money", "value": 1774}
			];
		}

		function createStartOverData() {
			return [
				{"key": "yes", "value": 3460},
				{"key": "no", "value": 2158}
			];
		}

		function createPersonalityByCollegeData() {
			return {
				"aap": {"INTJ": 4, "INTP": 4, "ENTJ": 3, "ENTP": 17, "INFJ": 1, "INFP": 3, "ENFJ": 1, "ENFP": 3, "ISTP": 24, "ISFP": 8, "ESTP": 26, "ESFP": 10, "ISTJ": 9, "ISFJ": 3, "ESTJ": 6, "ESFJ": 2},
				"arts": {"INTJ": 41, "INTP": 96, "ENTJ": 62, "ENTP": 161, "INFJ": 11, "INFP": 26, "ENFJ": 12, "ENFP": 31, "ISTJ": 189, "ISFJ": 48, "ESTJ": 135, "ESFJ": 28, "ISTP": 237, "ISFP": 73, "ESTP": 414, "ESFP": 85},
				"cals": {"INTJ": 32, "INTP": 66, "ENTJ": 38, "ENTP": 159, "INFJ": 7, "INFP": 22, "ENFJ": 5, "ENFP": 29, "ISTJ": 106, "ISFJ": 32, "ESTJ": 125, "ESFJ": 17, "ISTP": 200, "ISFP": 48, "ESTP": 422, "ESFP": 61},
				"engineering": {"INTJ": 32, "INTP": 84, "ENTJ": 30, "ENTP":115, "INFJ": 15, "INFP": 28, "ENFJ": 6, "ENFP": 17, "ISTJ": 137, "ISFJ": 43, "ESTJ": 90, "ESFJ": 20, "ISTP": 255, "ISFP": 71, "ESTP": 331, "ESFP": 57},
				"hotel": {"INTJ": 1, "INTP": 5, "ENTJ": 8, "ENTP": 42, "INFJ": 2, "INFP": 2, "ENFJ": 1, "ENFP": 8, "ISTJ": 19, "ISFJ": 4, "ESTJ": 38, "ESFJ": 5, "ISTP": 33, "ISFP": 9, "ESTP": 117, "ESFP": 17},
				"humec": {"INTJ": 6, "INTP": 19, "ENTJ": 14, "ENTP": 48, "INFJ": 6, "INFP": 5, "ENFJ": 6, "ENFP": 8, "ISTJ": 39, "ISFJ": 11, "ESTJ": 56, "ESFJ": 8, "ISTP": 60, "ISFP": 21, "ESTP": 137, "ESFP": 36},
				"ilr": {"INTJ": 5, "INTP": 17, "ENTJ": 14, "ENTP": 52, "INFJ": 1, "INFP": 3, "ENFJ": 3, "ENFP": 9, "ISTJ": 17, "ISFJ": 5, "ESTJ": 30, "ESFJ": 0, "ISTP": 36, "ISFP": 11, "ESTP": 126, "ESFP": 25}
			};
		}

		function getPersonalityTotalData() {
			return [
				{"key": "INTJ", "value": 121},
				{"key": "INTP", "value": 291},
				{"key": "ENTJ", "value": 169},
				{"key": "ENTP", "value": 594}, 
				{"key": "INFJ", "value": 43},
				{"key": "INFP", "value": 89},
				{"key": "ENFJ", "value": 34},
				{"key": "ENFP", "value": 105},
				{"key": "ISTJ", "value": 516},
				{"key": "ISFJ", "value": 146},
				{"key": "ESTJ", "value": 480},
				{"key": "ESFJ", "value": 80},
				{"key": "ISTP", "value": 845},
				{"key": "ISFP", "value": 241},
				{"key": "ESTP", "value": 1573},
				{"key": "ESFP", "value": 291},
			];
		}

		function createFridayData() {
			return [
				{"key": "pjs & netflix", "total": 2119},
				{"key": "mixer", "total": 1245},
				{"key": "netflix & chill", "total": 773},
				{"key": "bars", "total": 699},
				{"key": "annex", "total": 416},
			];
		}

		function createDateData() {
			return [
				{"key": "the commons", "total": 1335},
				{"key": "boba tea", "total": 1050},
				{"key": "collegetown bagels", "total": 999},
				{"key": "dinner in collegetown", "total": 801},
				{"key": "starbucks", "total": 316},
			];
		}

		function createPerfectData() {
			return [
				{"key": "hanging out with friends", "total": 2200},
				{"key": "exploring a city", "total": 1374},
				{"key": "going on an outdoor adventure", "total": 1043},
				{"key": "trying new cuisines", "total": 344},
				{"key": "visiting a museum", "total": 186},
			];
		}

		function createCommitmentData() {
			return [
				{"key": "I plan to meet my matches", "value": 854}, 
				{"key": "I will potentially meet with my matches", "value": 3006},
				{"key": "I just want to meet new people", "value": 1052},
				{"key": "I am taking this for fun and will probably not make an effort to meet", "value": 706}
			];
		}

		function convertNestedMapToList(map) {
			let keyList = Object.keys(map);
			var pList = Object.keys(map[keyList[0]]);

			let finalList = [];

			for (var i = 0; i < keyList.length; i++) {
				for (var j = 0; j < pList.length; j++)
				finalList.push({"college": keyList[i], "personality": pList[j], "total": map[keyList[i]][pList[j]]});
			}

			return finalList;
		}

		/** Functions for generating bar graph **/
		function getBarX(data, svgWidth, xd) {
			return d3.scaleBand()
				.domain(data.map(function(d) {return d[xd];}))
				.range([padding*5, svgWidth-(padding*5)])
				.paddingInner(0.4);
		}

		function getBarY(data, svgHeight) {
			return d3.scaleLinear()
				.domain([0, d3.max(data, function(d) {return +d.value;})])
				.range([svgHeight-padding*3, padding*3]);
		}

		function drawBars(svg, x, y, data, maxBarHeight, barWidth, color) {
			// create initial bars
			svg.selectAll(".bars")
				.data(data)
				.enter()
				.append("rect")
					.attr("x", function(d) {return x(d.key);})
					.attr("y", function(d) {return y(0);})
					.attr("fill", function(d) {return color;})
					.attr("height", function(d) {return maxBarHeight - y(0);})
					.attr("width", x.bandwidth());

			// animate the bars
			svg.selectAll("rect")
				.transition()
				.duration(800)
				.attr("y", function(d) {return y(d.value);})
				.attr("height", function(d) {return maxBarHeight - y(d.value);})
				.delay(function(d, i) {return i*100;});
		}

		function drawTotalText(barSvg, x, y, data, barWidth, gutter) {
			// create total text above bar
		    barSvg.selectAll(".total_text")
		    	.data(data)
				.enter()
		    	.append("text")
		    		.attr("class", "total_text")
		    		.text(function(d) {return d.value})
		    		.attr("x", function(d) {return x(d.key) + x.bandwidth()/2;})
					.attr("y", function(d) {return y(d.value) - gutter;})
					.style("text-anchor", "middle")
					.style("fill", darkTextColor)
					.style("font-weight", "bold")
					.style("font-family", "Inconsolata")
		        	.style("font-size", "12px")
		        	.style("opacity", 0);

		    // animate text
		    barSvg.selectAll(".total_text")
		    	.transition()
		    	.duration(900)
		    	.style("opacity", 1)
		    	.delay(function(d, i) {return i*100;});
		}

		function redrawXAxis(x, maxBarHeight, slantText = false) {
			d3.selectAll(".x_axis")
				.transition()
				.duration(0)
				.call(d3.axisBottom(x))
				.attr("transform", "translate(" + 0 + ", " + (maxBarHeight) + ")");

			d3.select(".domain").remove();
				
			if (slantText) {
				d3.selectAll(".x_axis .tick text")
			        .attr("transform", "rotate(-25)")
			        .style("text-anchor", "end");
			}
		}

		// code adapted from https://bl.ocks.org/mbostock/7555321
		function wrap(text, width) {
			text.each(function() {
			var text = d3.select(this),
			    words = text.text().split(/\s+/).reverse(),
			    word,
			    line = [],
			    lineNumber = 0,
			    lineHeight = 1.1, // ems
			    y = text.attr("y"),
			    dy = parseFloat(text.attr("dy")),
			    tspan = text.text(null).append("tspan").attr("x", 0).attr("y", y).attr("dy", dy + "em");
			while (word = words.pop()) {
			  line.push(word);
			  tspan.text(line.join(" "));
			  if (tspan.node().getComputedTextLength() > width) {
			    line.pop();
			    tspan.text(line.join(" "));
			    line = [word];
			    tspan = text.append("tspan").attr("x", 0).attr("y", y).attr("dy", ++lineNumber * lineHeight + dy + "em").text(word);
			  }
			}
			});
		}

		function handleBarLegendChange(d, circle_id) {
			d3.selectAll(circle_id)
				.transition()
				.duration(500)
				.style("fill", "#f8f8f8");

			d3.select("#key_" + d)
				.transition()
				.duration(500)
				.style("fill", darkTextColor);
		}

		function addTotalSignupText(barSvg) {
			barSvg.append("text")
				.attr("x", "50%")
				.attr("y", padding*2)
				.text("In 2020, we have " + getTotalPeople() + " people signed up to meet their perfect match!")
				.style("text-anchor", "middle")
				.style("fill", "#f8f8f8")
				.style("font-family", "Montserrat")
				.style("font-size", "20px")
				.style("font-weight", "bold");
			barSvg.append("text")
				.attr("x", "50%")
				.attr("y", padding*3.5)
				.text("Let's take a look at their breakdown:")
				.style("text-anchor", "middle")
				.style("fill", "#f8f8f8")
				.style("font-family", "Montserrat")
				.style("font-size", "20px")
				.style("font-weight", "bold");
		}

		function drawBarChart(svgClass) {
			let maxBarHeight = firstSvgHeight - padding*3;
			let barWidth = padding*2;

			let genderData = createGenderData();
			let yearData = createYearData();
			let ethnicityData = createEthnicityData();
			let activitiesData = createActivitiesData();
			let collegeData = createCollegeData();

			let barSvg = d3.select(svgClass);
			
			// addTotalSignupText(barSvg)

			let x = getBarX(genderData, firstSvgWidth, "key");
			let y = getBarY(genderData, firstSvgHeight);

			drawBars(barSvg, x, y, genderData, maxBarHeight, barWidth, "#A7333F");

			// add x axis
			barSvg.append("g")
				.attr("class", "x_axis")
				.attr("transform", "translate(" + 0 + ", " + (maxBarHeight) + ")")
				.call(d3.axisBottom(x))
				.style("font-family", "Inconsolata")
		        .style("font-size", "12px")
		        .select(".domain").remove();

		    drawTotalText(barSvg, x, y, genderData, barWidth, 5);
			
		    // key for bar chart
		   	let barLegend = ["gender", "year", "ethnicity", "college", "activities"];

		   	// create legend
		   	d3.select(svgClass).append("g")
		   	.selectAll(".key")
		   		.data(barLegend)
		   		.enter()
		   		.append("circle")
		   		.attr("class", "legend_circles")
		   		.attr('id', function(d, i) { return "key_" + d;})
		    	.attr('cx', function(d, i) { return firstSvgWidth-padding*4;})
		    	.attr('cy', function(d, i) { return 160 + i*30;})
		    	.attr('r', 8)
		    	.style('fill', '#f8f8f8')
		    	.style('stroke', darkTextColor)
		    	.style('stroke-width', 2)
		    	.on('click', function(d, i) {
		    		handleBarLegendChange(d, ".legend_circles");
		    		barSvg.selectAll("rect").remove();
		    		barSvg.selectAll(".total_text").remove();
		    		
		    		if (d == "year") {
		    			x = getBarX(yearData, firstSvgWidth, "key");
							y = getBarY(yearData, firstSvgHeight);

		    			drawBars(barSvg, x, y, yearData, maxBarHeight, barWidth, "#A7333F");
		    			drawTotalText(barSvg, x, y, yearData, barWidth, 5);
		    			redrawXAxis(x, maxBarHeight);

		    		}
		    		else if (d == "gender") {
		    			x = getBarX(genderData, firstSvgWidth, "key");
							y = getBarY(genderData, firstSvgHeight);

		    			drawBars(barSvg, x, y, genderData, maxBarHeight, barWidth, "#A7333F");
		    			drawTotalText(barSvg, x, y, genderData, barWidth, 5);
		    			redrawXAxis(x, maxBarHeight);
		    		} else if (d == "ethnicity") {
		    			x = getBarX(ethnicityData, firstSvgWidth, "key");
							y = getBarY(ethnicityData, firstSvgHeight);

		    			drawBars(barSvg, x, y, ethnicityData, maxBarHeight, barWidth, maroonColor);
		    			drawTotalText(barSvg, x, y, ethnicityData, barWidth, 5);
		    			redrawXAxis(x, maxBarHeight);

		    		} else if (d == "college") {
		    			x = getBarX(collegeData, firstSvgWidth, "key");
							y = getBarY(collegeData, firstSvgHeight);

		    			drawBars(barSvg, x, y, collegeData, maxBarHeight, barWidth, maroonColor);
		    			drawTotalText(barSvg, x, y, collegeData, barWidth, 5);
		    			redrawXAxis(x, maxBarHeight);

		    		} else if (d == "activities") {
		    			x = getBarX(activitiesData, firstSvgWidth, "key");
							y = getBarY(activitiesData, firstSvgHeight);

		    			drawBars(barSvg, x, y, activitiesData, maxBarHeight, barWidth, maroonColor);
		    			drawTotalText(barSvg, x, y, activitiesData, barWidth, 5);
		    			redrawXAxis(x, maxBarHeight, true);

		    		}
		    	});

		    handleBarLegendChange("gender", ".legend_circles");

		    // create legend labels
		    d3.select(svgClass).append("g")
		    .selectAll('.key_labels')
				.data(barLegend)
		    	.enter()
		    	.append('text')
		    	.attr('x', function(d, i) { return firstSvgWidth-padding*4 + 20;})
		    	.attr('y', function(d, i) { return 164 + i*30;})
		    	.text(function(d) {return d;})
		    	.style('fill', darkTextColor)
		    	.style("font-weight", "bold")
		    	.style("font-family", "Inconsolata")
	   			.style("font-size", "12px");
		}

		function drawHeightChart(svgClass) {
			let midwayPoint = secSvgHeight/2;

			let femaleHeight = createFemaleHeightData();
			let maleHeight = createMaleHeightData();

			let x = d3.scaleLinear()
				.domain([minHeight, femaleHeight.length+minHeight])
				.range([padding*5, secSvgWidth-(padding*5)]);

			let yfemale = d3.scaleLinear()
				.domain([0, d3.max([d3.max(femaleHeight), d3.max(maleHeight)])])
				.range([midwayPoint, (padding*3)]);

			let ymale = d3.scaleLinear()
				.domain([0, d3.max([d3.max(femaleHeight), d3.max(maleHeight)])])
				.range([midwayPoint, secSvgHeight-(padding*3)]);

			let heightSvg = d3.select(svgClass);

			let tooltip = d3.select("body")
				.append("div")
				.attr("class", "heightSvg_tooltip")
				.style("padding", 10)
				.style("position", "absolute")
				.style("z-index", "10")
				.style("visibility", "hidden")
				.attr("white-space", "pre-line")
				.style("background-color", "#fbfbfb")
				.style("border-radius", "5px")
				.style("border", "1px solid #cdcdcd");

			heightSvg.append("path")
				.datum(femaleHeight)
				.attr("class", "area")
				.attr("fill", pinkColor)
				.attr("stroke", pinkColor)
				.attr("stroke-width", "1")
				.attr("d", d3.area()
					.x(function (d, i) {return x(i+minHeight);})
					.y0(yfemale(0))
					.y1(function (d) {return yfemale(d)})
					.curve(d3.curveMonotoneX));

			heightSvg.append("path")
				.datum(maleHeight)
				.attr("fill", blueColor)
				.attr("stroke", blueColor)
				.attr("stroke-width", "1")
				.attr("d", d3.area()
					.x(function (d, i) {return x(i+minHeight);})
					.y0(ymale(0))
					.y1(function (d) {return ymale(d)})
					.curve(d3.curveMonotoneX));

			// add x axis
			heightSvg.append("g")
				.attr("class", "x_axis_height")
				.attr("transform", "translate(" + (0) + ", " + (midwayPoint) + ")")
				.call(d3.axisBottom(x))
				.style("font-family", "Inconsolata")
				.style("color", darkTextColor)
		        .style("font-size", "12px")
		        .select(".domain").remove();

		    heightSvg.append("text")
		    	.attr("transform", "translate(" + (secSvgWidth-padding*5) + ", " + (midwayPoint) + ")")
		    	.text("height (inches)")
		    	.style("font-family", "Inconsolata")
		    	.style("font-weight", "bold")
				.style("color", darkTextColor)
		        .style("font-size", "12px");

		    heightSvg.append("text")
		    	.attr("transform", "translate(" + (padding*4) + ", " + (midwayPoint-10) + ")")
		    	.text("female")
		    	.style("font-family", "Inconsolata")
		    	.style("font-weight", "bold")
		        .style("font-size", "12px");

		    heightSvg.append("text")
		    	.attr("transform", "translate(" + (padding*4) + ", " + (midwayPoint+20) + ")")
		    	.text("male")
		    	.style("font-family", "Inconsolata")
		    	.style("font-weight", "bold")
		        .style("font-size", "12px");

		    // no-hover tool tips - female median height comment
		    var medianFemale = calculateMedianForHeight(femaleHeight);
		    heightSvg.append("circle")
		    	.attr("class", "nohover_tooltip")
		    	.attr("cx", x(medianFemale))
	   			.attr("cy", yfemale(femaleHeight[medianFemale-minHeight]))
	   			.attr("r", 4)
	   			.style('stroke-width', 2)
    			.style('fill-opacity', 0)
	   			.attr("stroke", darkTextColor);
	   		heightSvg.append("text")
	   			.attr("class", "nohover_tooltip")
		    	.attr("x", x(medianFemale)+10)
	   			.attr("y", yfemale(femaleHeight[medianFemale-minHeight])-10)
	   			.text("median height: " + (medianFemale) + " in")
		    	.style("font-family", "Inconsolata")
		    	.style("font-weight", "bold")
		        .style("font-size", "12px");

		    // male median height comment
		    var medianMale = calculateMedianForHeight(maleHeight);
	   		heightSvg.append("circle")
	   			.attr("class", "nohover_tooltip")
		    	.attr("cx", x(medianMale))
	   			.attr("cy", ymale(maleHeight[medianMale-minHeight]))
	   			.attr("r", 4)
	   			.style('stroke-width', 2)
    			.style('fill-opacity', 0)
	   			.attr("stroke", darkTextColor);
	   		heightSvg.append("text")
	   			.attr("class", "nohover_tooltip")
		    	.attr("x", x(medianMale)-5)
	   			.attr("y", ymale(maleHeight[medianMale-minHeight])+20)
	   			.text("median height: " + medianMale + " in")
		    	.style("font-family", "Inconsolata")
		    	.style("font-weight", "bold")
		    	.style("text-anchor", "end")
		        .style("font-size", "12px");

		    // 6ft comment
		    heightSvg.append("circle")
	   			.attr("class", "nohover_tooltip")
		    	.attr("cx", x(72))
	   			.attr("cy", ymale(maleHeight[72-minHeight]))
	   			.attr("r", 4)
	   			.style('stroke-width', 2)
    			.style('fill-opacity', 0)
	   			.attr("stroke", darkTextColor);
	   		heightSvg.append("line")
	   			.attr("class", "nohover_tooltip")
	   			.attr("x1", x(72)+4)
	   			.attr("x2", x(75))
	   			.attr("y2", ymale(maleHeight[72-minHeight]))
	   			.attr("y1", ymale(maleHeight[72-minHeight]))
	   			.style('stroke-width', 2)
	   			.attr("stroke", darkTextColor);
	   		heightSvg.append("text")
	   			.attr("class", "nohover_tooltip")
		    	.attr("x", x(75)+4)
	   			.attr("y", ymale(maleHeight[72-minHeight])-5)
	   			.text("only ~30% of male participants are 6ft+")
		    	.style("font-family", "Inconsolata")
		    	.style("font-weight", "bold")
		        .style("font-size", "12px");
		    heightSvg.append("text")
	   			.attr("class", "nohover_tooltip")
		    	.attr("x", x(75)+4)
	   			.attr("y", ymale(maleHeight[72-minHeight])+10)
	   			.text("(but it's 2020 and it's time to forgo")
		    	.style("font-family", "Inconsolata")
		    	.style("font-weight", "bold")
		        .style("font-size", "12px");
		    heightSvg.append("text")
	   			.attr("class", "nohover_tooltip")
		    	.attr("x", x(75)+4)
	   			.attr("y", ymale(maleHeight[72-minHeight])+25)
	   			.text("patriarchal standards 🎉)")
		    	.style("font-family", "Inconsolata")
		    	.style("font-weight", "bold")
		        .style("font-size", "12px");

		    d3.select(svgClass).on("mousemove", function() {
		    	var offset = document.querySelector(svgClass).getBoundingClientRect();
	   
	   			d3.selectAll(".height_tooltip").remove();

		    	// window for bar chart
		    	if (d3.event.clientX - offset.x >= (padding*5)
		    		&& d3.event.clientX - offset.x < secSvgWidth-(padding*5)-10
		    		&& d3.event.clientY - offset.y > padding*2
		    		&& d3.event.clientY - offset.y < secSvgHeight-(padding*4)) {

		    		d3.selectAll("#height_tooltip")
		    			.transition()
		    			.attr("opacity", 1);

		    		d3.selectAll(".nohover_tooltip").attr("opacity", 0);

		    		var height = Math.round(x.invert(d3.event.clientX - offset.x));

		    		// set tooltip attributes
		    		var tooltipText = "<b>" + height + " inches | " + convertInToFeet((height)) + "</b>"
    				+ "<br /><b>female count: </b> " + femaleHeight[(height-minHeight)]
    				+ "<br /><b>male count: </b>" + maleHeight[(height-minHeight)];

    				// add tooltip to screen
	    			tooltip
		   				.html(tooltipText)
		   				.style("font-family", "Montserrat")
		   				.style("font-size", "12px")
			   			.style("visibility", "visible")
			   			.style("max-width", 150)
			   			.style("top", function() { return event.pageY - 10 + "px"; })
			   			.style("left", function() { return event.pageX - 150 +"px";
			   			});
			   		
			   		// add circles + line
			   		heightSvg.append("circle")
			   			.attr("class", "height_tooltip")
			   			.attr("cx", x(height))
			   			.attr("cy", yfemale(femaleHeight[height-minHeight]))
			   			.attr("r", 4)
			   			.style('stroke-width', 2)
		    			.style('fill-opacity', 0)
			   			.attr("stroke", whiteColor);
			   		heightSvg.append("circle")
			   			.attr("class", "height_tooltip")
			   			.attr("cx", x(height))
			   			.attr("cy", ymale(maleHeight[height-minHeight]))
			   			.attr("r", 4)
			   			.style('stroke-width', 2)
		    			.style('fill-opacity', 0)
			   			.attr("stroke", whiteColor);
			   		// make sure that lines are not drawn when circles are too close
			   		if (ymale(maleHeight[height-minHeight]) - yfemale(femaleHeight[height-minHeight]) >= 8) {
			   			heightSvg.append("line")
			   			.attr("class", "height_tooltip")
			   			.attr("x1", x(height))
			   			.attr("x2", x(height))
			   			.attr("y2", ymale(maleHeight[height-minHeight])-4)
			   			.attr("y1", yfemale(femaleHeight[height-minHeight])+4)
			   			.style('stroke-width', 2)
			   			.attr("stroke", whiteColor);
			   		}
			   			
				} else {
		    		tooltip.style("visibility", "hidden");

		    		d3.selectAll(".nohover_tooltip")
		    			.attr("opacity", 1);
		   		}
		    }).on("mouseleave", function () {
		    	d3.selectAll(".nohover_tooltip").attr("opacity", 1);
		    	tooltip.style("visibility", "hidden");
		    	d3.selectAll(".height_tooltip").remove();
	    	});

		}

		function drawSleepDials(svgClass) {
			let innerRadius = 50;
			let outerRadius = 100;

			let hoverX = -1;

			let sleepSvg = d3.select(svgClass);

			let sleepData = createSleepData();
			let wakeData = createWakeData();

			let maxBarHeight = thirdSvgHeight/2;

			let x = d3.scaleLinear()
				.domain([0, 23])
				.range([padding*5.5, thirdSvgWidth-padding*5.5])

			let y = d3.scaleLinear()
				.domain([0, 1860]) // max value
				.range([innerRadius, outerRadius]);

			let ySleep = d3.scaleLinear()
				.domain([0, 1860]) // max value
				.range([thirdSvgHeight/2, padding*4]);

			let yWake = d3.scaleLinear()
				.domain([0, 1860]) // max value
				.range([thirdSvgHeight/2, thirdSvgHeight-padding*4]);

			let line = d3.lineRadial()
				.angle(function(d, i) {return x(i)})
				.radius(function(d, i) {return y(d)});

			var area = d3.radialArea()
			  .angle(function(d, i) {
			    return x(i);
			  })
			  .innerRadius(function(d) {
			    return innerRadius;
			  })
			  .outerRadius(function(d, i) {
			    return y(d[i]);
			  })
			  .curve(d3.curveCatmullRom.alpha(1));

			let tooltip = d3.select("body")
				.append("div")
				.attr("class", "sleepSvg_tooltip")
				.style("padding", 10)
				.style("position", "absolute")
				.style("z-index", "10")
				.style("visibility", "hidden")
				.attr("white-space", "pre-line")
				.style("background-color", "#fbfbfb")
				.style("border-radius", "5px")
				.style("border", "1px solid #cdcdcd");

			// create initial bars
			sleepSvg.selectAll(".bars")
				.data(sleepData)
				.enter()
				.append("rect")
					.attr("class", "sleepBar")
					.attr("id", function(d, i) {return "sleepBar_" + i;})
					.attr("x", function(d, i) {return x(i);})
					.attr("y", function(d, i) {return ySleep(d[i]);})
					.attr("fill", function(d) {return maroonColor;})
					.attr("height", function(d, i) {return maxBarHeight- ySleep(d[i]);})
					.attr("width", padding-5);
			sleepSvg.selectAll(".bars")
				.data(wakeData)
				.enter()
				.append("rect")
					.attr("class", "wakeBar")
					.attr("id", function(d, i) {return "wakeBar_" + i;})
					.attr("transform", "translate(0, " + 15 +")")
					.attr("x", function(d, i) {return x(i);})
					.attr("y", function(d, i) {return 250;})
					.attr("fill", function(d) {return blueColor;})
					.attr("height", function(d, i) {return yWake(d[i])-maxBarHeight;})
					.attr("width", padding-5);

			// x-axis
			sleepSvg.append("g")
				.attr("class", "x_axis_sleep")
				.attr("transform", "translate(" + ((padding-5)/2) + ", " + (thirdSvgHeight/2)  + ")")
				.call(d3.axisBottom(x).tickFormat(function (d) { return d+":00";}).tickSize(0))
				.style("font-family", "Inconsolata")
				.style("color", darkTextColor)
		        .style("font-size", "12px")
		        .select(".domain").remove();
		    sleepSvg.append("text")
		    	.attr("class", "x_axis_sleep")
		    	.attr("x", padding*5)
		    	.attr("y", thirdSvgHeight/2 - padding)
		    	.text("when do people")
		    	.style("font-family", "Inconsolata")
		    	.style("text-anchor", "end")
		    	.style("font-weight", "bold")
		        .style("font-size", "12px")
	        sleepSvg.append("text")
		    	.attr("class", "x_axis_sleep")
		    	.attr("x", padding*5)
		    	.attr("y", thirdSvgHeight/2 - padding + 15)
		    	.text("fall asleep?")
		    	.style("font-family", "Inconsolata")
		    	.style("text-anchor", "end")
		    	.style("font-weight", "bold")
		        .style("font-size", "12px")
	        sleepSvg.append("text")
		    	.attr("class", "x_axis_sleep")
		    	.attr("x", padding*5)
		    	.attr("y", thirdSvgHeight/2 + padding+15)
		    	.text("when do people")
		    	.style("font-family", "Inconsolata")
		    	.style("text-anchor", "end")
		    	.style("font-weight", "bold")
		        .style("font-size", "12px")
	        sleepSvg.append("text")
		    	.attr("class", "x_axis_sleep")
		    	.attr("x", padding*5)
		    	.attr("y", thirdSvgHeight/2 + padding +30)
		    	.text("wake up?")
		    	.style("font-family", "Inconsolata")
		    	.style("text-anchor", "end")
		    	.style("font-weight", "bold")
		        .style("font-size", "12px");
		    sleepSvg.append("text")
		    	.attr("class", "x_axis_sleep")
		    	.attr("x", thirdSvgWidth-padding*4.5)
		    	.attr("y", thirdSvgHeight/2 + 10)
		    	.text("time (24hr)")
		    	.style("font-family", "Inconsolata")
		    	.style("font-weight", "bold")
		        .style("font-size", "12px");

		    // late sleepers comment
		    sleepSvg.append('line')
		    	.attr("class", "nohover_sleep")
		    	.attr("x1", x(4)+(padding-5)/2 -1)
		    	.attr("x2", x(6)+(padding-5)/2+1) 
		    	.attr("y1", thirdSvgHeight/2 - 20)
		    	.attr("y2", thirdSvgHeight/2 - 20)
		    	.style('stroke-width', 2)
	   			.attr("stroke", darkTextColor);
   			sleepSvg.append('line')
 		    	.attr("class", "nohover_sleep")
		    	.attr("x1", x(4)+(padding-5)/2)
		    	.attr("x2", x(4)+(padding-5)/2)
		    	.attr("y1", thirdSvgHeight/2 - 20)
		    	.attr("y2", thirdSvgHeight/2 - 15)
		    	.style('stroke-width', 2)
	   			.attr("stroke", darkTextColor);
	   		sleepSvg.append('line')
	   			.attr("class", "nohover_sleep")
		    	.attr("x1", x(6)+(padding-5)/2)
		    	.attr("x2", x(6)+(padding-5)/2)
		    	.attr("y1", thirdSvgHeight/2 - 20)
		    	.attr("y2", thirdSvgHeight/2 - 15)
		    	.style('stroke-width', 2)
	   			.attr("stroke", darkTextColor);
	   		sleepSvg.append('line')
	   			.attr("class", "nohover_sleep")
		    	.attr("x1", x(5)+(padding-5)/2)
		    	.attr("x2", x(5)+(padding-5)/2)
		    	.attr("y1", thirdSvgHeight/2 - 20)
		    	.attr("y2", thirdSvgHeight/2 - 60)
		    	.style('stroke-width', 2)
	   			.attr("stroke", darkTextColor);
   			sleepSvg.append("text")
		    	.attr("class", "nohover_sleep")
		    	.attr("x", x(5)+(padding-5)/2 - padding/2)
		    	.attr("y", thirdSvgHeight/2 - 90)
		    	.text("42 people generally fall")
		    	.style("font-family", "Inconsolata")
		    	.style("font-weight", "bold")
		        .style("font-size", "12px");
		    sleepSvg.append("text")
		    	.attr("class", "nohover_sleep")
		    	.attr("x", x(5)+(padding-5)/2 - padding/2)
		    	.attr("y", thirdSvgHeight/2 - 75)
		    	.text("asleep past 4:00am")
		    	.style("font-family", "Inconsolata")
		    	.style("font-weight", "bold")
		        .style("font-size", "12px");

		    //median sleep times
	        sleepSvg.append('line')
		    	.attr("class", "nohover_sleep")
		    	.attr("x1", x(0)+(padding-5)/2)
		    	.attr("x2", x(0)+(padding-5)/2)
		    	.attr("y1", ySleep(sleepData[0][0])-4)
		    	.attr("y2", ySleep(sleepData[0][0])-40)
		    	.style('stroke-width', 2)
	   			.attr("stroke", darkTextColor);
	   		sleepSvg.append('circle')
		    	.attr("class", "nohover_sleep")
		    	.attr("cx", x(0)+(padding-5)/2)
		    	.attr("cy", ySleep(sleepData[0][0]))
		    	.attr("r", 4)
		    	.style('fill-opacity', 0)
		    	.style('stroke-width', 2)
	   			.attr("stroke", darkTextColor);
   			sleepSvg.append("text")
		    	.attr("class", "nohover_sleep")
		    	.attr("x", x(0)+(padding-5)/2 - padding/2)
		    	.attr("y", ySleep(sleepData[0][0])- 50)
		    	.text("median: 12:00am")
		    	.style("font-family", "Inconsolata")
		    	.style("font-weight", "bold")
		        .style("font-size", "12px");
	        sleepSvg.append('line')
		    	.attr("class", "nohover_sleep")
		    	.attr("x1", x(8)+(padding-5)/2)
		    	.attr("x2", x(8)+(padding-5)/2)
		    	.attr("y1", yWake(sleepData[8][8])+maxBarHeight-padding*4+15)
		    	.attr("y2", yWake(sleepData[8][8])+maxBarHeight-padding*4+20+30)
		    	.style('stroke-width', 2)
	   			.attr("stroke", darkTextColor);
   			sleepSvg.append("text")
		    	.attr("class", "nohover_sleep")
		    	.attr("x", x(8)+(padding-5)/2 - padding/2)
		    	.attr("y", yWake(sleepData[8][8])+maxBarHeight-padding*4+20+30+15)
		    	.text("median: 8:00am")
		    	.style("font-family", "Inconsolata")
		    	.style("font-weight", "bold")
		        .style("font-size", "12px");
        	sleepSvg.append('circle')
		    	.attr("class", "nohover_sleep")
		    	.attr("cx", x(8)+(padding-5)/2)
		    	.attr("cy", yWake(sleepData[8][8])+maxBarHeight-padding*4+15-4)
		    	.attr("r", 4)
		    	.style('fill-opacity', 0)
		    	.style('stroke-width', 2)
	   			.attr("stroke", darkTextColor);

	   		d3.select(svgClass).on("mousemove", function() {
		    	let offset = document.querySelector(svgClass).getBoundingClientRect();
	   
	   			d3.selectAll(".nohover_sleep").attr("opacity", 0);

	   			if (d3.event.clientX - offset.x >= (padding*5.5)
		    		&& d3.event.clientX - offset.x < thirdSvgWidth-(padding*5)
		    		&& d3.event.clientY - offset.y > padding*2
		    		&& d3.event.clientY - offset.y < thirdSvgHeight-(padding*2)) {

	   				// get cursor's current x
	   				let tempX = x.invert((d3.event.clientX - offset.x)-(5)).toFixed(0);

	   				// set tooltip attributes
		    		var tooltipText = "<b> time: " + tempX + ":00" + "</b>"
    				+ "<br /><b>sleep count: </b> " + sleepData[tempX][String(tempX)]
    				+ "<br /><b>wake count: </b>" + wakeData[tempX][String(tempX)];

    				// add tooltip to screen
	    			tooltip
		   				.html(tooltipText)
		   				.style("font-family", "Montserrat")
		   				.style("font-size", "12px")
			   			.style("visibility", "visible")
			   			.style("max-width", 150)
			   			.style("top", function() { return event.pageY - 0 + "px"; })
			   			.style("left", function() { return event.pageX - 130 +"px";
			   			});

	   				// bc function acts on mousemove, check that hovered bar changes
	   				if (hoverX != tempX) {

	   					//if change, set old bars back to original colors
	   					d3.select("#sleepBar_" + hoverX)
	   					.transition()
	   					.style("fill", maroonColor);
	   					d3.select("#wakeBar_" + hoverX)
	   					.transition()
	   					.style("fill", blueColor);

	   					// set new bars to hover colo
	   					d3.select("#sleepBar_" + tempX)
	   					.transition()
	   					.style("fill", lightGreyColor);
		   				d3.select("#wakeBar_" + tempX)
		   					.transition()
		   					.style("fill", lightGreyColor);

	   					hoverX = tempX;
	   				}

	   				d3.selectAll("#sleepSvg_tooltip")
		    			.transition()
		    			.attr("opacity", 1);

	   			} else {
	   				d3.selectAll(".sleepBar")
	   					.transition()
	   					.style("fill", maroonColor);

	   				d3.selectAll(".wakeBar")
	   					.transition()
	   					.style("fill", blueColor);

	   				d3.selectAll(".nohover_sleep").attr("opacity", 1);

	   				d3.selectAll("#sleepSvg_tooltip")
		    			.transition()
		    			.attr("opacity", 0);

		    		hoverX = -1;
		    		tooltip.style("visibility", "hidden");
	   			}
	   		});
		}

		function createSingleDonut(innerRadius, outerRadius, svg, pieClass, data, xOffset, yOffset) {
			let pie = d3.pie()
				.value(function(d) { return d.value; })
				.sort(null);

			let arc = d3.arc()
				.innerRadius(innerRadius)
				.outerRadius(outerRadius);

			let newArc = d3.arc()
				.innerRadius(innerRadius+7.5)
				.outerRadius(outerRadius+7.5);	

			let textArc = d3.arc()
				.innerRadius(innerRadius+10)
				.outerRadius(outerRadius+10);

			// add total text in the middle of pie
			svg.append("text")
				.datum(data)
				.attr("class", pieClass + "_text")
				.attr("x", xOffset)
				.attr("y", yOffset)
				.style("fill", darkTextColor)
				.style("alignment-baseline", "middle")
				.style("text-anchor", "middle")
				.style("font-family", "Inconsolata")
				.style("font-weight", "bold")
          		.style("font-size", 50);

          	// draw pie segments
			svg.datum(data).selectAll("." + pieClass)
			  	.data(pie)
			.enter().append("path")
				.attr("class", pieClass)
				.attr("id", function(d) {
					return pieClass + "_" + d.data.key;
				})
				.attr("fill", function(d, i) { return d3.schemePastel2[i]; })
				.attr("d", arc)
				.attr("transform", "translate(" + xOffset + "," + yOffset + ")")
				.on("mouseover", function(d) {
					svg.select("." + pieClass + "_text")
						.text(d.data.value);

					d3.select(this)
						.transition()
						.duration(300)
						.attr("d", newArc);
				})
				.on("mouseout", function() {
					svg.select("." + pieClass + "_text")
						.text("");

					d3.select(this)
						.transition()
						.duration(250)
						.attr("d", arc);
				});

			// add pie segment labels
			svg.datum(data).selectAll("#" + pieClass + "_label")
			  	.data(pie).enter()
			  	.append('text')
                .attr('dy', '.35em')
                .text(function(d) { return d.data.key;})
                .attr('transform', function(d) {
                    var pos = textArc.centroid(d);
                    var x = pos[0];
                    var y = pos[1];
                    var hyp = Math.sqrt(x*x + y*y);
                    return 'translate(' + (xOffset + x/hyp*(outerRadius+15)) + "," + (yOffset + y/hyp*(outerRadius+15))+ ')';
                })
                .style('text-anchor', function(d) {
                    return (midAngle(d)) < Math.PI ? 'start' : 'end';
                })
                .style("font-family", "Inconsolata")
		    	.style("font-weight", "bold")
		        .style("font-size", "12px");
		
		}

		function midAngle(d) { return d.startAngle + (d.endAngle - d.startAngle) / 2; }

		function addPollText(svg, x, y, outerRadius, text1, text2) {
			svg.append("text")
				.attr("x", x)
				.attr("y", y-outerRadius-60)
				.text(text1)
				.style("fill", darkTextColor)
				.style("alignment-baseline", "middle")
				.style("text-anchor", "middle")
				.style("font-family", "Inconsolata")
				.style("font-weight", "bold")
          		.style("font-size", 15);
          	svg.append("text")
				.attr("x", x)
				.attr("y", y-outerRadius-45)
				.text(text2)
				.style("fill", darkTextColor)
				.style("alignment-baseline", "middle")
				.style("text-anchor", "middle")
				.style("font-family", "Inconsolata")
				.style("font-weight", "bold")
          		.style("font-size", 15);
		}

		function drawPollDonuts(svgClass) {
			let innerRadius = 70;
			let outerRadius = 120;
			let pollSvg = d3.select(svgClass);

			let mealData = createMealData();
			let startOverData = createStartOverData();
			let timeMoneyData = createTimeMoneyData();
			let qualityData = createBestQualityData();

			addPollText(pollSvg, 200, 200, outerRadius,"Who would you most want", "to have a meal with?");
			createSingleDonut(innerRadius, outerRadius, pollSvg, "path_meal", mealData, 200, 200);

			addPollText(pollSvg, 600, 200, outerRadius,"If you could start college", "all over again, would you?");
			createSingleDonut(innerRadius, outerRadius, pollSvg, "path_start_over", startOverData, 600, 200);

			addPollText(pollSvg, 200, 600, outerRadius,"Would you rather have more", "time or more money?");
			createSingleDonut(innerRadius, outerRadius, pollSvg, "path_time_money", timeMoneyData, 200, 600);

			addPollText(pollSvg, 600, 600, outerRadius,"What quality do you value", "the most?");
			createSingleDonut(innerRadius, outerRadius, pollSvg, "path_quality", qualityData, 600, 600);
		}

		function drawHeatMap(svgClass) {
			let gridSize = 40;
			let gridSpacing = 5;

			let offset = 80;

			let heatmapSvg = d3.select(svgClass)
				.append('g')
				.attr("transform", "translate(" + offset + ", 100)");
			let heatmapData = convertNestedMapToList(createPersonalityByCollegeData());
			// console.log(heatmapData);

			let collegeTotal = {"aap": 124, "arts": 1649, "cals":1369, "engineering": 1331, "hotel": 311, "humec":480, "ilr": 354};

			let pList = {"INTJ": "Architect", "INTP": "Logician", "ENTJ": "Commander", "ENTP": "Debater", "INFJ": "Advocate", "INFP": "Mediator", "ENFJ": "Protagonist", "ENFP": "Campaigner", "ISTP": "Virtuoso", "ISFP": "Adventurer", "ESTP": "Entrepreneur", "ESFP": "Entertainer", "ISTJ": "Logistician", "ISFJ": "Defender", "ESTJ": "Executive", "ESFJ": "Consul"};

			let colorScale = d3.scaleSequential(d3.interpolateBlues)
				.domain([0, d3.max(heatmapData, function(d) {return d.total/collegeTotal[d.college]})]);

			let tooltip = d3.select("body")
				.append("div")
				.attr("class", svgClass + "_tooltip")
				.style("padding", 10)
				.style("position", "absolute")
				.style("z-index", "10")
				.style("visibility", "hidden")
				.attr("white-space", "pre-line")
				.style("background-color", "#fbfbfb")
				.style("border-radius", "5px")
				.style("border", "1px solid #cdcdcd");

			heatmapSvg.selectAll(".heatMapRect")
				.data(heatmapData)
				.enter()
				.append('rect')
				.attr("class", "heatmap_rect")
				.attr("id", function(d) {return "heatmap_" + d.college + "_" + d.personality;})
				.attr("y", function(d, i) { return Math.floor(i/16) * gridSize })
              	.attr("x", function(d, i) { return (i % 16) * gridSize; })
              	.attr("rx", 4)
              	.attr("ry", 4)
              	.attr("width", gridSize-gridSpacing)
              	.attr("height", gridSize-gridSpacing)
              	.style("fill", function(d) {;return colorScale(d.total/collegeTotal[d.college]);})
              	.on("mousemove", function (d) {
              		var tooltipText = "<b>" + d.personality + " | " + pList[d.personality] + "</b>"
              			+ "<br/> <b>college:</b> " + d.college
              			+ "<br/> <b>total:</b> " + d.total;

              		// add tooltip to screen
	    			tooltip
		   				.html(tooltipText)
		   				.style("font-family", "Montserrat")
		   				.style("font-size", "12px")
			   			.style("visibility", "visible")
			   			.style("max-width", 150)
			   			.style("top", function() { return event.pageY + 20 + "px"; })
			   			.style("left", function() { 
			   				if (d3.event.clientX < 500) {
			   					return event.pageX;
			   				} else {
			   					return event.pageX - 110;
			   				}
			   			});

			   		tooltip.style("visibility", "visible");
		       	})
              	.on("mouseout", function(d) {
              		tooltip.style("visibility", "hidden");
              	});

            // hide notes when tooltip is showing
            d3.select(svgClass).on("mousemove", function () {
            	let wOffset = document.querySelector(svgClass).getBoundingClientRect();

	   			if (d3.event.clientX - wOffset.x >= (offset)
		    		&& d3.event.clientX - wOffset.x < offset+ gridSize*16
		    		&& d3.event.clientY - wOffset.y > 100
		    		&& d3.event.clientY - wOffset.y < 100+gridSize*7) {
	   				d3.selectAll(".heatmap_notes").style("visibility", "hidden");
	   			} else {
	   				d3.selectAll(".heatmap_notes").style("visibility", "visible");
	   			}
            });

            // draw y-axis
            var y = d3.scaleBand().domain(Object.keys(collegeTotal))
            	.range([0, gridSize*7]);
            d3.select(svgClass)
            	.append('g')
            	.attr("class", "y_axis")
            	.attr("transform", "translate(" + (offset-5) + ", 100)")
                .call(d3.axisLeft(y).ticks(7).tickSize(0))
		        .style("font-family", "Inconsolata")
		        .style("font-size", 12)
		        .style("font-weight", "bold")
		        .select(".domain").remove();

		    // draw x-axis
		    var x = d3.scaleBand().domain(Object.keys(pList))
		    	.range([-1*(gridSpacing/2), (gridSize * 16)-(gridSpacing/2)]);
		    d3.select(svgClass)
            	.append('g')
            	.attr("transform", "translate(" + offset + ", 95)")
                .call(d3.axisTop(x))
		        .style("font-family", "Inconsolata")
		        .style("font-size", 12)
		        .style("font-weight", "bold")
		        .select(".domain").remove();

		    // most common mbti note
		    heatmapSvg.append("line")
		    	.attr("class", "heatmap_notes")
		    	.attr("x1", gridSize*10+2)
		    	.attr("x2", gridSize*11 - gridSpacing - 2)
		    	.attr("y1", gridSize*7)
		    	.attr("y2", gridSize*7)
		    	.style("stroke", darkTextColor)
		    	.style("stroke-width", 2);
		    heatmapSvg.append("line")
		    	.attr("class", "heatmap_notes")
		    	.attr("x1", gridSize*10+2)
		    	.attr("x2", gridSize*11 - gridSpacing - 2)
		    	.attr("y1", gridSize*7 + 5)
		    	.attr("y2", gridSize*7 + 5)
		    	.style("stroke", darkTextColor)
		    	.style("stroke-width", 2);
		    heatmapSvg.append("path")
		    	.attr("class", "heatmap_notes")
		    	.attr("d", "M " + (gridSize*10 + gridSize*11 - gridSpacing)/2 + " " + (gridSize*7 + 5)
		    		+ "L " + (gridSize*10 + gridSize*11 - gridSpacing)/2 + " " + (gridSize*7.5))
		    	.style("stroke", darkTextColor)
		    	.style("stroke-width", 2)
		    	.style("fill", "none");
		    heatmapSvg.append("text")
		    	.attr("class", "heatmap_notes")
		    	.attr("x", gridSize*9.9)
		    	.attr("y", gridSize*7.9)
		    	.text("most common mbti type is estp at 28%")
		    	.style("font-family", "Inconsolata")
		    	.style("font-weight", "bold")
		        .style("font-size", "12px");
		    heatmapSvg.append("text")
		    	.attr("class", "heatmap_notes")
		    	.attr("x", gridSize*9.9)
		    	.attr("y", gridSize*8.2)
		    	.text("however we're not surprised by this since")
		    	.style("font-family", "Inconsolata")
		    	.style("font-weight", "bold")
		        .style("font-size", "12px");
		    heatmapSvg.append("text")
		    	.attr("class", "heatmap_notes")
		    	.attr("x", gridSize*9.9)
		    	.attr("y", gridSize*8.5)
		    	.text("estp is also known as \"the entrepreneur\"")
		    	.style("font-family", "Inconsolata")
		    	.style("font-weight", "bold")
		        .style("font-size", "12px");

		    // second most common mbti note
		    heatmapSvg.append("line")
		    	.attr("class", "heatmap_notes")
		    	.attr("x1", gridSize*8+2)
		    	.attr("x2", gridSize*9 - gridSpacing - 2)
		    	.attr("y1", gridSize*7)
		    	.attr("y2", gridSize*7)
		    	.style("stroke", darkTextColor)
		    	.style("stroke-width", 2);
		    heatmapSvg.append("line")
		    	.attr("class", "heatmap_notes")
		    	.attr("x1", gridSize*8+2)
		    	.attr("x2", gridSize*9 - gridSpacing - 2)
		    	.attr("y1", gridSize*7 + 5)
		    	.attr("y2", gridSize*7 + 5)
		    	.style("stroke", darkTextColor)
		    	.style("stroke-width", 2);
		    heatmapSvg.append("path")
		    	.attr("class", "heatmap_notes")
		    	.attr("d", "M " + (gridSize*8 + gridSize*9 - gridSpacing)/2 + " " + (gridSize*7 + 5)
		    		+ "L " + (gridSize*8 + gridSize*9 - gridSpacing)/2 + " " + (gridSize*7.5)
		    		+ "L " + (gridSize*7.6) + " " + (gridSize*7.5))
		    	.style("stroke", darkTextColor)
		    	.style("stroke-width", 2)
		    	.style("fill", "none");
		   	heatmapSvg.append("text")
		    	.attr("class", "heatmap_notes")
		    	.attr("x", gridSize*4.5)
		    	.attr("y", gridSize*7.5)
		    	.text("second most common")
		    	.style("font-family", "Inconsolata")
		    	.style("font-weight", "bold")
		        .style("font-size", "12px");
		    heatmapSvg.append("text")
		    	.attr("class", "heatmap_notes")
		    	.attr("x", gridSize*4.5)
		    	.attr("y", gridSize*7.8)
		    	.text("mbti type is istp")
		    	.style("font-family", "Inconsolata")
		    	.style("font-weight", "bold")
		        .style("font-size", "12px");
		    heatmapSvg.append("text")
		    	.attr("class", "heatmap_notes")
		    	.attr("x", gridSize*4.5)
		    	.attr("y", gridSize*8.1)
		    	.text("(the virtuoso) at 15%")
		    	.style("font-family", "Inconsolata")
		    	.style("font-weight", "bold")
		        .style("font-size", "12px");

		    // learn more note
		    heatmapSvg.append("text")
		    	.attr("x", 0)
		    	.attr("y", gridSize*9.5)
		    	.html("*learn more about the 16 mbti type <a href=\"https:\/\/www.16personalities.com\/personality-types\" style=\"text-decoration: underline;\">here<\/a>")
		    	.style("font-family", "Inconsolata")
		    	.style("font-weight", "bold")
		        .style("font-size", "12px");
		       
		}

		function drawCommitmentBarChart(svgClass) {
			let maxBarHeight = commitmentSvgHeight - padding*3;
			let barWidth = padding*2;

			let commitementData = createCommitmentData();

			let barSvg = d3.select(svgClass);
			
			// addTotalSignupText(barSvg)

			let x = getBarX(commitementData, firstSvgWidth, "key");
			let y = getBarY(commitementData, commitmentSvgHeight);

			drawBars(barSvg, x, y, commitementData, maxBarHeight, barWidth, "#A7333F");

			// add x axis
			barSvg.append("g")
				.attr("class", "x_axis")
				.attr("transform", "translate(" + 0 + ", " + (maxBarHeight) + ")")
				.call(d3.axisBottom(x))
				.selectAll(".tick text")
				.call(wrap, x.bandwidth())
						.style("font-family", "Inconsolata")
						.style("font-size", "12px");
			
			barSvg.select(".domain").remove();
		        

		  drawTotalText(barSvg, x, y, commitementData, barWidth, 5);
		}



		requestInitialData();
		function final() {
			drawBarChart(".generalBar");
			drawHeightChart(".heightChart");
			drawSleepDials(".timeDials");
			drawPollDonuts(".polls");
			drawHeatMap(".heatmap");
			drawCommitmentBarChart(".commitmentBar");
		}
		
	</script>
</body>